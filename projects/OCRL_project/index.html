<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>TinyMPC | Khai Nguyen</title> <meta name="author" content="Khai Nguyen"> <meta name="description" content="CMU 16-715: Optimal Control &amp; Reinforcement Learning - Spring 23.&lt;br&gt; ðŸŽ® TinyMPC: A Model Predictive Control for Embedded Applications"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon-1024.png?5302343bab5aea09f0f1ad5592fe9d06"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://khainguyen.github.io/projects/OCRL_project/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">KhaiÂ </span>Nguyen</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">TinyMPC</h1> <p class="post-description">CMU 16-715: Optimal Control &amp; Reinforcement Learning - Spring 23.<br> ðŸŽ® TinyMPC: A Model Predictive Control for Embedded Applications</p> </header> <article> <p>This is my project within the course <a href="https://github.com/Optimal-Control-16-745/" rel="external nofollow noopener" target="_blank">16-715: Optimal Control &amp; Reinforcement Learning</a> at Carnegie Mellon University in Spring 2023 semester. Some key points:</p> <p>TinyMPC: A Model Predictive Control for Embedded Applications | C/C++, Julia, Python, Crazyflie, STM32, Teensy | <a href="/assets/pdf/OCRL_Final_Report.pdf">[pdf]</a> <a href="https://docs.google.com/presentation/d/1cFMTpDRfxqL3kF0Zi5DV3jDhsEP8uIU8RSy6qDEq0X8/edit?usp=sharing" rel="external nofollow noopener" target="_blank">[slides]</a></p> <ul> <li>Led a team to develop a novel efficient convex model-predictive control algorithm targeting embedded systems.</li> <li>Introduced a new full-state quaternion-based LQR/LQI controller onto Crazyflie (C/C++ on STM32); accomplished robust hovering performance.</li> <li>Evaluated the augmented Lagrangian-based MPC solver on Teensy Arduino and STM32F4.</li> </ul> <hr> <p><strong>Abstract</strong>â€”We introduce a novel model predictive control (MPC) framework designed for running on low-resource hardware. Our approach utilizes an Augmented Lagrangian-iLQR optimization method to handle trajectory optimization and constraint management. The framework is optimized to run on several microcontrollers, including the Teensy 4.1, STM32F401, and the Crazyflie 2.1 drone, which uses an STM32F405 processor. We detail the algorithm implementation, hardware optimization techniques, and provide a comparison of the frameworkâ€™s runtime performance with other state-of-the-art solvers. Additionally, we present the results of testing the framework on the Crazyflie 2.1 drone, which shows that it can solve the full-state quadrotor problem with a minimum frequency of 16Hz, while a complementary LQR is implemented to stabilize the drone at 50Hz.</p> <hr> <p>For more details, please check our report.</p> <h2 id="introduction">Introduction</h2> <p>In recent years, significant strides have been made in the field of robotics, particularly in deep learning (DL) and reinforcement learning (RL), resulting in a range of improved capabilities and applications. However, these advanced techniques often demand significant computing resources, which can pose challenges for many robotic applications. This stands in contrast to a significant portion of robotics that utilizes embedded systems with severely limited computing resources. These systems include palmsized toy robots like the Crazyflie quadrotor and the Petoi Bittle quadruped, as well as mission-critical robots like NASAâ€™s Mars Perseverance rove. The Crazyflie and Bittle employ affordable and accessible commercial microcontrollers, such as families of STM32 and Teensy, respectively. Meanwhile, the Perseverance rover relies on RAD750, a radiation-hardened version of the PowerPC 750 processor from the previous century. Clearly, the need for resource-constrained robotic applications is widespread. Operating within a tight computational budget, these embedded systems require innovative approaches to enable the efficacy of advanced techniques.</p> <p>Our contributions to the field of optimal control are three-fold. Firstly, we have developed a highly efficient and extensible open-source optimal control solver in C. Secondly, we have created a user-friendly MPC interface that simplifies the setup and compilation of our solver on various hardware platforms. Finally, we have provided benchmark results to demonstrate the efficacy of our approach and a hardware demonstration to showcase its practicality.</p> <h2 id="design">Design</h2> <h3 id="constrained-optimal-control-problem">Constrained Optimal Control Problem</h3> <p>Up to this point, we have not considered any constraints on the state x or input u. Real-world systems have many types of physical or desired limitations. Some popular constraints are box constraints on the state and input at each time step (to ensure that the solution is realizable on hardware and to encourage smoothness in the solution), equality constraints on the goal state (to ensure that that a desired final position is reached), and second-order cone constraints to, for example, enforce thrust limits.</p> <p>To handle constraints, we use the augmented Lagrangian method (ALM) which enforces constraints into the cost function. Generally, our tracking problem is convex, and a global solution can be found with only one constrained backward pass. However, multiple iterations are needed to satisfy dual feasibility. Below is the pseudo-code of our AL-TVLQR algorithm.</p> <div class="row justify-content-sm-center"> <div class="col-sm-6 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/acsi/plan_flip-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/acsi/plan_flip-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/acsi/plan_flip-1400.webp"></source> <img src="/assets/acsi/plan_flip.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="Title" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Generalized flipping speed reference in previous work </div> <p>The flipping planner outputs a trajectory for the quadrotor to follow. This is divided into five stages as follows:</p> <ul> <li>Ascent phase: Here the quadrotor is boosted to obtain moments and inertia before executing the flip.</li> <li>Increasing angular velocity phase: In this stage, the roll rate slowly increases from 0 to Ï‰max.</li> <li>Max angular velocity phase: At this stage the Ï‰max is commanded.</li> <li>Decreasing angular velocity phase: In this stage, the roll rate decreases from Ï‰max to 0.</li> <li>Stabilizing phase: This phase is activated after a complete flip. The quadrotor is stabilized and enters normal flight mode</li> </ul> <h3 id="flipping-controller">Flipping Controller</h3> <p>Following the previous work, a <a href="https://ctms.engin.umich.edu/CTMS/index.php?example=Introduction&amp;section=ControlPID" rel="external nofollow noopener" target="_blank">PD-like controller</a> is designed for tracking the angular velocity from the planner.</p> \[u(t) = k_p e(t) + k_d \dot{e}(t)\] <p>The PD controller can be tuned to obtain a desired behavior from the controller by varying the \(k_p\) and \(k_d\) terms. This controller provides the control efforts in the form of three torques, and a thrust is set as the droneâ€™s weight to maintain a constant height and not to saturate the actuators.</p> <h3 id="stabilizing-controller">Stabilizing Controller</h3> <p>An <a href="http://underactuated.mit.edu/lqr.html" rel="external nofollow noopener" target="_blank">LQR controller</a> is designed to re-stabilize the drone after a complete flip. It is noteworthy that we require a robust controller because initial errors for this controller can be significant. LQR controller is a full-state feedback controller and is designed using the linearized mathematical model of the quadrotor. An optimization problem is solved to obtain the gains of the LQR controller. The LQR controller is tuned by varying the \(Q\) and \(R\) matrices to get the desired performance from the controller.</p> <h2 id="results">Results</h2> <p>There are several testing cases for flipping maneuvers depending on open-loop vs. closed-loop planner, not tuned vs. tuned attitude rate PID, and PID vs. LQR stabilizer. Single flip is tested first with detailed analysis before moving to the more challenging cases. Please see our report for more details.</p> <div class="row justify-content-sm-center"> <div class="col-sm-12 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/acsi/flip_steps-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/acsi/flip_steps-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/acsi/flip_steps-1400.webp"></source> <img src="/assets/acsi/flip_steps.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="Title" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Snapshots of our flipping maneuver from the demo video </div> <div class="row justify-content-sm-center"> <div class="col-sm-6 mt-1 mt-md-0"> <iframe height="600" src="https://www.youtube.com/embed/81XYgRthhc0" title="YouTube video player" frameborder="0" style="border: 0px solid #bbb; border-radius: 10px; width: 100%;" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe> </div> <div class="col-sm-6 mt-1 mt-md-0"> <iframe height="600" src="https://www.youtube.com/embed/y1OanjJ8mtQ" title="YouTube video player" frameborder="0" style="border: 0px solid #bbb; border-radius: 10px; width: 100%;" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe> </div> </div> <div class="caption"> Left: LQR hovering <br> Right: Autonomous flip </div> <h2 id="conclusions">Conclusions</h2> <p>This work has provided a complete flipping maneuver pipeline which is very challenging for a micro quadrotorâ€™s acrobatic application. Our approach divides the process into three steps: ascent, flipping and re-stabilization. Following that, we developed a flipping planner, a flipping controller, and a stabilizing controller. An open-loop flipping planner will generate a three-stage attitude rate reference based on time, compared to the generalized flipping angle feedback of a closed-loop one. This planner must consider the limited sensing and actuating capacity of the quadrotor. To track that reference, we use a flipping controller, which has a PD-like architecture, then switch to a regular controller after completing a flip. For that re-stabilization phase, both cascaded PID and LQR controllers are considered. These modules are implemented via Python API as well as directly Crazyflie firmware. Finally, this paper has detailed experimental testing and demonstrated successful flip maneuvers. However, the majority of the tests witness failures due to many different factors, including communication delay, open-loop drawbacks, and not-robust-enough LQR controllers. Many modifications to the current pipeline can be made to improve the performance in the future. Firstly, the closed-loop planner, which needs more integration tests, has provided the stabilizing controller with good initial conditions. Secondly, all modules should be directly implemented in the on-board microprocessor, which will significantly help with the delay problem. Last but not least, more accurate state measurements and different architectures can boost the LQR stabilizerâ€™s robustness and overall performance.</p> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> Â© Copyright 2023 Khai Nguyen. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Last updated: December 12, 2023. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?07b8786bab9b4abe90d10e61f7d12ff7" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>